# `eks/bootstrap`

This module installs the "baseline" set of capabilities that all Cloud City EKS clusters should have, including:
- External Secrets operator.
- AWS Load Balancer controller.
- ArgoCD.
- EBS CSI system (with a default storage class, as well as a "retained" storage class whose volumes are not deleted once
  detached).

This module is separate from `eks/cluster` since it must be executed with a helm/kubernetes provider active and pointed
at the target cluster. Since provider initialization cannot be done lazily in Terraform, this necessitates a separate
module. Clusters provisioned in Cloud City should instantiate a `eks/cluster` first, then this module, with appropriate
dependencies configured via Terragrunt.

**Note:** when applying or destroying this module, the `argocd` Helm release can take quite some time to initialize or
to destroy, due to the long turnaround time and poller frequency in interacting with AWS load balancers via the LBC. If
things do time out related to ArgoCD, a good first place to look when debugging those issues is the `argocd-server`
`Service` (`LoadBalancer`) resource in the target EKS cluster. That resource's logs may indicate the reason for the
failure.

**Note:** Destroying this module will not necessarily destroy argo-deployed applications or Kubernetes resources created
by previous iterations of this module. If more thorough destruction is needed, use manual `kubectl` commands and/or
move the namespaces/resources containing destroy-needful objects into Terraform IaC as first-class `"resource"`s.

<!-- BEGIN_TF_DOCS -->
## Requirements

No requirements.

## Providers

| Name | Version |
|------|---------|
| <a name="provider_aws"></a> [aws](#provider\_aws) | n/a |
| <a name="provider_kubernetes"></a> [kubernetes](#provider\_kubernetes) | n/a |

## Modules

| Name | Source | Version |
|------|--------|---------|
| <a name="module_alarms"></a> [alarms](#module\_alarms) | ./eks-automated-monitoring | n/a |
| <a name="module_argocd"></a> [argocd](#module\_argocd) | ../../helm | n/a |
| <a name="module_argocd_irsa_role"></a> [argocd\_irsa\_role](#module\_argocd\_irsa\_role) | ../service_account | n/a |
| <a name="module_external_secrets"></a> [external\_secrets](#module\_external\_secrets) | ../../helm | n/a |

## Resources

| Name | Type |
|------|------|
| [aws_vpc_security_group_egress_rule.aws_managed_cluster_sg_egress_restrict](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/vpc_security_group_egress_rule) | resource |
| [kubernetes_namespace.namespaces](https://registry.terraform.io/providers/hashicorp/kubernetes/latest/docs/resources/namespace) | resource |
| [kubernetes_storage_class.ebs_sc](https://registry.terraform.io/providers/hashicorp/kubernetes/latest/docs/resources/storage_class) | resource |
| [aws_region.current](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/region) | data source |
| [aws_vpc_security_group_rule.cluster_egress_rules](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/vpc_security_group_rule) | data source |

## Inputs

| Name | Description | Type | Default | Required |
|------|-------------|------|---------|:--------:|
| <a name="input_argocd_helm_chart_version"></a> [argocd\_helm\_chart\_version](#input\_argocd\_helm\_chart\_version) | Version of the Helm chart for ArgoCD | `string` | `"8.1.2"` | no |
| <a name="input_aws_internal_cluster_egress_rule_ids"></a> [aws\_internal\_cluster\_egress\_rule\_ids](#input\_aws\_internal\_cluster\_egress\_rule\_ids) | Security group rule ID of the allow-all-outbound egress rule generated by AWS on the AWS-managed EKS egress security group, if any | `set(string)` | n/a | yes |
| <a name="input_chart_ecr_image_account_id"></a> [chart\_ecr\_image\_account\_id](#input\_chart\_ecr\_image\_account\_id) | AWS Account ID containing chart images to be used by this module. Should not ordinarily be changed from the default (the infra account) | `string` | `"381492150796"` | no |
| <a name="input_cluster_name"></a> [cluster\_name](#input\_cluster\_name) | EKS Cluster | `string` | n/a | yes |
| <a name="input_enable_argocd"></a> [enable\_argocd](#input\_enable\_argocd) | Deploy ArgoCD? | `bool` | `true` | no |
| <a name="input_external_secrets_helm_chart_version"></a> [external\_secrets\_helm\_chart\_version](#input\_external\_secrets\_helm\_chart\_version) | Version of the Helm chart for External-Secrets | `string` | `"0.18.2"` | no |
| <a name="input_root_ca_arn"></a> [root\_ca\_arn](#input\_root\_ca\_arn) | ARN of the root CA | `string` | n/a | yes |
| <a name="input_root_domain_name"></a> [root\_domain\_name](#input\_root\_domain\_name) | Domain name that this cluster is expecting to recieve traffic on, including subdomains. Ex: data-platform.sandbox.cloud-city, or dev.cloud-city | `string` | n/a | yes |
| <a name="input_tags"></a> [tags](#input\_tags) | Tags to apply to the resources | `map(string)` | `{}` | no |

## Outputs

| Name | Description |
|------|-------------|
| <a name="output_argocd_domain_name"></a> [argocd\_domain\_name](#output\_argocd\_domain\_name) | Domain for ArgoCD in this cluster; can be used in other pipelines, such as the 'argocd-gw' Gateway configuration in '../tooling/traefik.tf |
| <a name="output_argocd_namespace"></a> [argocd\_namespace](#output\_argocd\_namespace) | Namespace of ArgoCD-server; can be used in other pipelines, such as the 'argocd-gw' Gateway configuration in '../tooling/traefik.tf |
| <a name="output_argocd_service_account_name"></a> [argocd\_service\_account\_name](#output\_argocd\_service\_account\_name) | Service account for use with ArgoCD applications |
| <a name="output_root_ca_arn"></a> [root\_ca\_arn](#output\_root\_ca\_arn) | ARN of the root CA - used by a Custom Resource in Kubernetes |
| <a name="output_root_domain_name"></a> [root\_domain\_name](#output\_root\_domain\_name) | Root DNS passthrough - check variables for details |
<!-- END_TF_DOCS -->
